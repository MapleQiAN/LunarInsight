# 阈值配置
# 控制各阶段的质量门限

# 阶段 2: 实体链接
entity_linking:
  # 自动接受阈值
  accept_threshold: 0.85
  
  # 待复核阈值（低于此值但高于 reject_threshold 的进入复核队列）
  review_threshold: 0.65
  
  # 拒绝阈值（低于此值直接丢弃）
  reject_threshold: 0.4
  
  # 候选生成参数
  candidate_generation:
    bm25_top_k: 20          # BM25 检索 Top-K
    vector_top_k: 20        # 向量检索 Top-K
    combined_top_k: 10      # 合并后 Top-K
  
  # 精排权重
  ranking_weights:
    lexical_similarity: 0.2   # 词形相似度
    semantic_similarity: 0.4  # 语义相似度
    context_match: 0.2        # 上下文一致性
    type_consistency: 0.1     # 类型一致性
    prior_frequency: 0.1      # 先验频次

# 阶段 3: 论断抽取
claim_extraction:
  # 论断置信度阈值
  min_confidence: 0.7
  
  # 论断长度限制
  min_length: 20
  max_length: 500
  
  # 关系置信度阈值
  relation_min_confidence: 0.6
  
  # 每个 Chunk 最多抽取的论断数
  max_claims_per_chunk: 5

# 阶段 4: 主题社区
theme_building:
  # Louvain 算法参数（优化）
  louvain:
    resolution: 1.0           # 分辨率（越高社区越细）
    max_iterations: 50        # 减少迭代次数（通常50次足够收敛）
    tolerance: 0.001          # 放宽容忍度（加速收敛）
    random_seed: 42           # 随机种子（保证可复现）
    concurrency: 4            # GDS 并发线程数
  
  # 多尺度社区检测（优化）
  multi_scale:
    enabled: true            # 是否启用多尺度检测
    level1_resolution: 0.5    # Level 1 粗粒度分辨率
    level2_resolution: 1.5    # Level 2 细粒度分辨率
    level1_min_themes: 3      # Level 1 最小主题数
    level1_max_themes: 10     # Level 1 最大主题数（适度放宽）
    level1_optimal_range: [5, 8]  # Level 1 最优范围
    level2_min_themes: 2      # Level 2 每个父主题的最小子主题数（降低限制）
    level2_max_themes: 12     # Level 2 每个父主题的最大子主题数
    level2_optimal_range: [4, 8]  # Level 2 最优范围
    
    # 分辨率自适应调整策略
    resolution_adjustment:
      method: "binary_search"  # binary_search | golden_section | fixed_multiplier
      max_iterations: 5        # 最大调整次数
      tolerance: 1             # 主题数量容差
    
    # 社区质量过滤
    quality_filter:
      enabled: false           # 暂不启用（待实现）
      min_modularity: 0.3      # 最小模块度
      min_internal_density: 0.2  # 最小内部密度
      max_external_connections: 0.3  # 最大外部连接比例
  
  # 关系权重融合参数（优化）
  relation_weights:
    cooccur_weight: 0.4       # 共现权重 α
    semantic_weight: 0.4     # 语义相似度权重 β
    claim_weight: 0.2        # 论断共现权重 γ
    min_weight_threshold: 0.15  # 最小权重阈值（提高阈值，减少噪声边）
    max_edges_per_node: 15   # 每个节点最多保留的边数（适度增加）
    degree_normalization: false  # 度归一化（暂不启用，待实现）
    min_degree_threshold: 2  # 最小度数要求
  
  # 主题卡片参数（优化）
  summary:
    max_concepts_per_summary: 12    # 每个主题摘要的最大概念数（适度增加）
    max_claims_per_summary: 6       # 每个主题摘要的最大论断数
    summary_max_length: 600         # 摘要最大长度
    
    # 批量生成配置
    batch_generation:
      enabled: true            # 是否启用批量生成
      batch_size: 5            # 每批处理5个主题
      max_concurrent_batches: 2  # 最多2批并发
    
    # 摘要缓存
    cache:
      enabled: false           # 暂不启用（待实现Redis集成）
      ttl: 86400               # 24小时
      similarity_threshold: 0.9  # 社区成员相似度阈值（用于缓存命中）
    
    # 摘要质量过滤
    quality_filter:
      min_length: 50           # 最小摘要长度
      max_repetition: 0.3      # 最大重复率
      require_keywords: true   # 必须包含关键词
  
  # 社区大小过滤
  min_community_size: 3      # 最小社区成员数
  max_community_size: 100    # 最大社区成员数（超过则再分）
  
  # 全局主题库
  global_theme:
    enabled: false           # 是否启用全局主题库（跨文档）
    rebuild_interval: 86400 # 重建间隔（秒，默认1天）

# 阶段 5: 谓词治理
predicate_governance:
  # OTHER 谓词占比告警阈值
  other_predicate_warning_ratio: 0.1
  
  # 自动扩表参数（见 predicates.yaml）
  auto_expand_min_occurrences: 50
  auto_expand_min_confidence: 0.8

# 阶段 7: GraphRAG 检索
query:
  # 检索参数
  local_search:
    max_hops: 2               # 图遍历最大跳数
    max_nodes: 50             # 最大返回节点数
  
  global_search:
    top_communities: 5        # Top-K 社区
  
  hybrid_search:
    local_weight: 0.6         # Local 权重
    global_weight: 0.4        # Global 权重
  
  # 重排序参数
  reranking:
    top_k: 10                 # 初始召回 Top-K
    final_k: 5                # 最终返回 Top-K
  
  # 生成参数
  generation:
    max_evidence_chunks: 5    # 最多引用证据块数
    max_context_length: 4000  # 最大上下文长度（tokens）
    temperature: 0.1          # 生成温度（越低越确定）

# 阶段 8: 评价与反馈
metrics:
  # 孤立节点告警阈值
  isolated_node_warning_ratio: 0.05
  
  # Alias 增长率告警阈值（每天）
  alias_growth_warning_rate: 0.2
  
  # 评测数据集大小
  evaluation:
    entity_linking_samples: 100     # 实体链接标注样本数
    qa_test_set_size: 50            # 问答测试集大小

# 篇章切分
chunking:
  # 滑动窗口参数
  window_size: 4            # 窗口大小（句子数）
  step_size: 2              # 步长（句子数）
  
  # 句子长度过滤
  min_sentence_length: 10   # 最短句子长度
  max_sentence_length: 1000 # 最长句子长度

# 指代消解
coreference:
  # 代词映射最大距离（句子数）
  max_pronoun_distance: 3
  
  # Alias 置信度阈值
  alias_min_confidence: 0.8

  # 质量门控阈值
  quality_gates:
    # rewrite 模式：强替换（通过门槛）
    rewrite_coverage_min: 0.6      # 覆盖率最低要求
    rewrite_conflict_max: 0.15      # 冲突率最高容忍
    
    # local 模式：局部替换（降级）
    local_coverage_min: 0.3         # 覆盖率最低要求
    local_conflict_max: 0.25         # 冲突率最高容忍
    
    # alias_only 模式：只挂别名（最低要求）
    alias_only_coverage_min: 0.1    # 覆盖率最低要求
  
  # 打分权重
  scoring_weights:
    distance_decay: 0.4             # 句距衰减权重
    parenthesis_boost: 0.8          # 括号简称强约束提升
    type_consistency: 0.2            # 类型一致性权重
    semantic_similarity: 0.0         # 语义相似度权重（暂未实现）
    syntactic_consistency: 0.0      # 句法一致性权重（暂未实现）
  
  # 候选生成参数
  candidate_generation:
    context_window: 3                # 语境窗口大小（句子数）
    max_candidates_per_mention: 5    # 每个提及的最大候选数
  
  # 一致性校验参数
  consistency:
    alias_consistency_strict: true   # 括号别名严格一致性
    window_consistency_enabled: true # 窗口内一致性检查

# 向量化
embedding:
  # 批量处理大小
  batch_size: 100
  
  # 向量相似度阈值（用于去重）
  similarity_threshold: 0.95
  
  # 嵌入模型
  model: "text-embedding-3-small"
  dimension: 1536

# 性能控制（优化）
performance:
  # LLM 调用并发数（优化）
  llm_concurrency: 10         # 提高并发数（根据API限制调整）
  llm_batch_size: 5           # 批量调用大小
  llm_timeout: 60             # 增加超时（批量调用可能更慢）
  llm_retry:
    max_retries: 3            # 最大重试次数
    backoff_factor: 2         # 退避因子
    retry_on: ["rate_limit", "timeout", "server_error"]  # 重试条件
  
  # Neo4j 批量写入优化
  batch_write_size: 200       # 增加批量大小
  batch_write_concurrency: 4  # 并发写入数
  
  # 向量计算优化
  vector_computation:
    use_gpu: false            # 如有GPU可启用
    chunk_size: 1000          # 向量计算分块大小
    parallel_workers: 4       # 并行工作线程数
  
  # 内存优化
  memory:
    max_graph_size: 10000     # 最大图节点数（超过则采样）
    sampling_ratio: 0.8       # 采样比例
    cache_size_mb: 512        # 缓存大小（MB）
  
  # 最大处理文档大小（字节）
  max_document_size: 10485760  # 10 MB
  
  # 超时设置
  timeouts:
    llm_call: 60              # LLM 调用超时（秒，增加以支持批量调用）
    neo4j_query: 60           # Neo4j 查询超时（秒）
    total_processing: 1200    # 总处理超时（秒，20 分钟）

